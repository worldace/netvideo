<!DOCTYPE html>
<meta charset="utf-8">
<title>jsplayer</title>
<!--  ■jsplayer http://wp.me/ppmtz-1Cu  -->





<style>
.jsplayer{
    box-sizing: border-box;
    visibility: hidden;
}

.jsplayer-video{
    position: absolute;
}

.jsplayer-screen{
    background-color: #000;
    width: 640px;
    height: 360px;
    overflow: hidden;
    white-space : nowrap;
    cursor: default;
    -ms-user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    user-select: none;
    position: relative;
}

.jsplayer-screen:focus{
    outline: none;
}

.jsplayer-screen-osd{
    font-family: Arial, sans-serif;
    position: absolute;
    right: 2%;
    top: 5%;
    background-color: #000;
    color:#0f0;
    z-index: 3;
}

.jsplayer-screen:-ms-fullscreen{
    position: absolute;
    width: 100% !important;
    height: 100% !important;
	left: 0;
 	top: 0;
}

.jsplayer-screen:-webkit-full-screen{
    position: absolute;
    width: 100% !important;
    height: 100% !important;
	left: 0;
 	top: 0;
}

.jsplayer-screen:-moz-full-screen{
    position: absolute;
    width: 100% !important;
    height: 100% !important;
	left: 0;
 	top: 0;
}

.jsplayer-screen:fullscreen{
    position: absolute;
    width: 100% !important;
    height: 100% !important;
	left: 0;
 	top: 0;
}

.jsplayer-controller{
    display: block;
    width: 640px;
    height: 55px;
    line-height: 1;
    color: white;
    text-decoration: none;
    background: #47494f;
    border-color: #2f3034 #2f3034 #232427;
    background-image: linear-gradient(to bottom, #555, #333 66%, #000);
    cursor: default;
    -ms-user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    user-select: none;
    position:relative;
    visibility:visible;
}

.jsplayer-controller-wrap{
    padding: 0 6px;
    position:absolute;
    top: 5px;
}

.jsplayer-controller-currentTime,
.jsplayer-controller-totalTime{
    font-family: Arial, sans-serif;
    font-size: 12px;
    vertical-align: 6px;
    padding: 0;
    display: inline-block;
    width: 35px;
}

.jsplayer-controller-currentTime{
    text-align: right;
}

.jsplayer-controller-totalTime{
    text-align: left;
}

.jsplayer-controller-playButton,
.jsplayer-controller-volumeButton,
.jsplayer-controller-commentButton,
.jsplayer-controller-fullscreenButton{
    margin: 0 3px;
    padding: 0;
    border: none;
	cursor: pointer;
}

.jsplayer-controller-timeSeek,
.jsplayer-controller-volumeSeek{
    display: inline-block;
    margin: 0 5px;
    padding: 0;
    height: 20px;
}

.jsplayer-controller-timeSeek{
    width: 333px;
}

.jsplayer-controller-volumeSeek{
    width: 100px;
}

.jsplayer-controller-timeSeekBar,
.jsplayer-controller-volumeSeekBar{
    position: relative;
    height: 5px;
    margin: 0 0 8px 0;
    padding: 0;
    background-color: #fff;
    border-radius: 2px;
    width: 100%;
    top: 7px;
}

.jsplayer-controller-timeSeekBar{
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAAICAIAAABcT7kVAAAAFUlEQVQI12N0WX+DgYGBiYGBgSQKAGI2AdswIf1pAAAAAElFTkSuQmCC");
    background-repeat: no-repeat;
    background-position: 0;
    background-size : 0;
}

.jsplayer-controller-timeSeekPointer,
.jsplayer-controller-volumeSeekPointer{
    position: absolute;
	cursor: pointer;
	width: 10px;
	height: 18px;
	background-color: #ccc;
    top: -7px;
    left: 0px;
    background-image: linear-gradient(to bottom, #ccc, #aaa);
    border: solid 1px #999;
    border-radius: 3px;
    display: inline;
}

.jsplayer-form{
    width: 100%;
    position: absolute;
    top:29px;
}

.jsplayer-form-input{
    width: 80%;
    height: 26px;
    box-shadow: 3px 3px 3px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    border-radius: 0;
    padding:4px 6px 3px 12px;
    vertical-align:middle;
    ime-mode: active;
    box-sizing: border-box;
}

.jsplayer-form-button{
    width: 20%;
    height: 26px;
    text-decoration: none;
    text-align: center;
    padding: 3px 15px 3px 15px;
    font-size: 14px;
    color: #fff;
    background-color: #5ba825;
    background: linear-gradient(to bottom, #84be5c 0%, #84be5c 50%, #5ba825 50%, #5ba825 100%);
    border: 1px solid #377d00;
    border-radius: 0;
    line-height: 1;
    vertical-align: middle;
    font-family: 'MS PGothic', Meiryo, sans-serif;
	cursor: pointer;
    box-sizing: border-box;
}

.jsplayer-comment{
    font-family: 'MS PGothic', Meiryo, sans-serif;
    position: absolute;
    left: 100%;
    line-height: 1;
    z-index: 2;
    color: #fff;
    text-shadow: -1px -1px #333, 1px -1px #333,	-1px 1px #333, 1px 1px #333;
    animation-fill-mode: forwards;
    animation-timing-function: linear;
    animation-duration: 17s;
    opacity: 0.75;
}

.jsplayer-thumbnail{
    display: none;
    position: absolute;
    border: solid 1px #47494f;
    z-index: 20;
}
</style>





<div class="jsplayer"
  ><div class="jsplayer-screen" tabindex="1"
    ><video class="jsplayer-video" loop></video
  ></div
  ><div class="jsplayer-controller"
    ><div class="jsplayer-controller-wrap"
      ><img class="jsplayer-controller-playButton" width="20" height="20" src=""
      ><span class="jsplayer-controller-currentTime">00:00</span
      ><div class="jsplayer-controller-timeSeek"
        ><div class="jsplayer-controller-timeSeekBar"
          ><span class="jsplayer-controller-timeSeekPointer"></span
        ></div
      ></div
      ><span class="jsplayer-controller-totalTime">00:00</span
      ><img class="jsplayer-controller-volumeButton" width="20" height="20" src=""
      ><div class="jsplayer-controller-volumeSeek"
        ><div class="jsplayer-controller-volumeSeekBar"
          ><span class="jsplayer-controller-volumeSeekPointer"></span
        ></div
      ></div
      ><img class="jsplayer-controller-commentButton" width="20" height="20" src=""
      ><img class="jsplayer-controller-fullscreenButton" width="20" height="20" src=""
    ></div
    ><form class="jsplayer-form" action="javascript:void(0)"
      ><input class="jsplayer-form-input" type="text" name="コメント" value="" autocomplete="off" spellcheck="false" maxlength="60" tabindex="2" disabled
      ><input class="jsplayer-form-button" type="submit" value="コメントする" disabled
      ><input class="jsplayer-form-vid" type="hidden" name="id" value=""
      ><input class="jsplayer-form-time" type="hidden" name="動画投稿時間" value=""
    ></form
  ></div
></div>





<script>
//■ player
var $v = document.querySelector('.jsplayer');


$v.appName = 'jsplayer';


$v.entrypoint = function(url, width, height){
    width  = width  || 960;
    height = height || 540;
    $v.screen.style.width  = width + "px";
    $v.screen.style.height = height + "px";
    $v.controller.style.width = width + "px";
    $v.controller.timeSeek.style.width = width - 307 + "px";

    $v.controller.playButton.setAttribute("src", $v.controller.parts.play);
    $v.controller.volumeButton.setAttribute("src", $v.controller.parts.volume);
    $v.controller.commentButton.setAttribute("src", $v.controller.parts.commenton);
    $v.controller.fullscreenButton.setAttribute("src", $v.controller.parts.fullscreen);

    $v.comment.keyframe(width);
    $v.comment.setting(height);

    if(navigator.userAgent && navigator.userAgent.indexOf('Edge/') >= 0){ //Edge(Fall Creators)でコメントが表示されないバグ対策
        var style = document.createElement('style');
        style.innerHTML = '.jsplayer-comment{opacity:1;}';
        document.head.appendChild(style);
    }

    $v.screen.pos                         = $v.screen.getBoundingClientRect();
    $v.controller.timeSeekBar.pos         = $v.controller.timeSeekBar.getBoundingClientRect();
    $v.controller.volumeSeekBar.pos       = $v.controller.volumeSeekBar.getBoundingClientRect();
    $v.controller.volumeSeekPointer.Width = $v.controller.volumeSeekPointer.getBoundingClientRect().width;
    $v.controller.timeSeekPointer.Width   = $v.controller.timeSeekPointer.getBoundingClientRect().width;

    $v.user = $v.fn.loadLocalStorage("jsplayer") || {};
    $v.user.volume = Number($v.user.volume) || 1;
    $v.controller.volumeSeekPointer.setPosition($v.user.volume);

    $v.style.visibility = "visible";

    $v.screen.focus();

    if     (document.fullscreenEnabled)      { document.addEventListener("fullscreenchange",       $v.screen.fullscreenEvent); }
    else if(document.msFullscreenEnabled)    { document.addEventListener("MSFullscreenChange",     $v.screen.fullscreenEvent); }
    else if(document.webkitFullscreenEnabled){ document.addEventListener("webkitfullscreenchange", $v.screen.fullscreenEvent); }
    else if(document.mozFullScreenEnabled)   { document.addEventListener("mozfullscreenchange",    $v.screen.fullscreenEvent); }

    window.addEventListener('unload', function(event){
        $v.fn.saveLocalStorage("jsplayer", $v.user);
    });

    if(url){
        $v.video.src = url;
    }
};


$v.addEventListener('keydown', function(event){
    $v.controller.style.visibility = "visible";
    if(event.target.tagName.match(/input/i)){
        return true;
    }

    if(event.which == 32){ //Space
        $v.form.input.focus();
    }
    else if(event.which == 13 && event.ctrlKey){ //Ctrl+Enter ※IE11で効かない
        $v.screen.toggleFullscreen();
    }
    else if(event.which == 13){ //Enter
        $v.video.paused ? $v.video.play() : $v.video.pause();
    }
    else if(event.which == 39 && event.ctrlKey){ //Ctrl+→
        $v.video.setTime($v.video.currentTime + 30);
    }
    else if(event.which == 39 && event.shiftKey){ //Shift+→
        $v.video.setTime($v.video.currentTime + 30);
    }
    else if(event.which == 37 && event.ctrlKey){ //Ctrl+←
        $v.video.setTime($v.video.currentTime - 30);
    }
    else if(event.which == 37 && event.shiftKey){ //Shift+←
        $v.video.setTime($v.video.currentTime - 30);
    }
    else if(event.which == 39){ //→
        $v.video.setTime($v.video.currentTime + 15);
    }
    else if(event.which == 37){ //←
        $v.video.setTime($v.video.currentTime - 15);
    }
    else if(event.which == 36){ //Home
        $v.video.setTime(0);
    }
    else if(event.which == 35){ //End
        $v.video.setTime($v.video.duration - 10);
    }
    else if(event.which == 38){ //↑
        $v.video.setVolume($v.video.volume + 0.1);
    }
    else if(event.which == 40){ //↓
        $v.video.setVolume($v.video.volume - 0.1);
    }
    else if(event.which == 107){ //num+
        $v.video.setSpeed($v.video.playbackRate + 0.1);
    }
    else if(event.which == 187 && event.shiftKey){ //+
        $v.video.setSpeed($v.video.playbackRate + 0.1);
    }
    else if(event.which == 109){ //num-
        $v.video.setSpeed($v.video.playbackRate - 0.1);
    }
    else if(event.which == 189){ //-
        $v.video.setSpeed($v.video.playbackRate - 0.1);
    }
    else{
        return true;
    }

    event.preventDefault();
});




//■ screen
$v.screen = $v.querySelector(".jsplayer-screen");


$v.screen.showOSD = function(str){
    var osd = document.createElement("span");
    osd.textContent = str;
    osd.className   = "jsplayer-screen-osd";
    osd.style.fontSize = $v.comment.fontSize + "px";

    $v.screen.clearOSD();
    $v.screen.appendChild(osd);
    $v.screen.osdTimer = window.setTimeout($v.screen.clearOSD, 3000);
};


$v.screen.clearOSD = function(){
    var osd = $v.screen.querySelectorAll(".jsplayer-screen-osd");
    for(var i = osd.length-1; i >= 0; i--){
        $v.screen.removeChild(osd[i]);
    }
    if($v.screen.osdTimer){
        window.clearTimeout($v.screen.osdTimer);
    }
};


$v.screen.isFullscreen = function(){
    var element = document.fullscreenElement || document.msFullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement;
    return (element && element.className == $v.screen.className) ? true : false;
};


$v.screen.toggleFullscreen = function(){
    if(!$v.screen.isFullscreen()){
        if     ($v.screen.requestFullscreen)      { $v.screen.requestFullscreen(); }
        else if($v.screen.msRequestFullscreen)    { $v.screen.msRequestFullscreen(); }
        else if($v.screen.webkitRequestFullscreen){ $v.screen.webkitRequestFullscreen(); }
        else if($v.screen.mozRequestFullScreen)   { $v.screen.mozRequestFullScreen(); }
    }
    else{
        if     (document.exitFullscreen)      { document.exitFullscreen(); }
        else if(document.msExitFullscreen)    { document.msExitFullscreen(); }
        else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
        else if(document.mozCancelFullScreen) { document.mozCancelFullScreen(); }
    }
};


$v.screen.fullscreenEvent = function(){
    if($v.screen.isFullscreen()){
        $v.screen.pos = {left:0, top:0, right:screen.width, bottom:screen.height, width:screen.width, height:screen.height}; //IE11で正常に取得できないので手動設定
        $v.screen.addEventListener('click', $v.controller.toggle);
        $v.screen.addEventListener('mousemove', $v.screen.mousemoveEvent);
        $v.screen.style.cursor = "none";
        $v.controller.intoScreen();
    }
    else{
        $v.screen.pos = $v.screen.getBoundingClientRect();
        $v.screen.removeEventListener('click', $v.controller.toggle);
        $v.screen.removeEventListener('mousemove', $v.screen.mousemoveEvent);
        if($v.screen.mousemoveTimer){
            window.clearTimeout($v.screen.mousemoveTimer);
        }
        $v.screen.style.cursor = "auto";
        $v.controller.outofScreen();
    }

    $v.controller.timeSeekBar.pos   = $v.controller.timeSeekBar.getBoundingClientRect();
    $v.controller.volumeSeekBar.pos = $v.controller.volumeSeekBar.getBoundingClientRect();

    $v.video.fit();
    $v.comment.setting($v.screen.pos.height);
    $v.comment.clear();
    $v.screen.focus();
};


$v.screen.mousemoveEvent = function(){
    $v.screen.style.cursor = "auto";
    if($v.screen.mousemoveTimer){
        window.clearTimeout($v.screen.mousemoveTimer);
    }
    $v.screen.mousemoveTimer = window.setTimeout(function(){ $v.screen.style.cursor = "none"; }, 2500);
};




//■ video
$v.video = $v.querySelector(".jsplayer-video");


$v.video.fit = function(){
    if(!$v.screen.pos.width || !$v.video.videoWidth){
        return;
    }
    var pos = $v.fn.contentFit($v.screen.pos.width, $v.screen.pos.height, $v.video.videoWidth, $v.video.videoHeight);

    $v.video.style.width  = pos.w + "px";
    $v.video.style.height = pos.h + "px";
    $v.video.style.left   = pos.x + "px";
    $v.video.style.top    = pos.y + "px";
};


$v.video.setTime = function(sec){
    if(!$v.video.duration){
        return;
    }
    if(sec < 1){
        sec = 0;
    }
    if(sec > $v.video.duration){
        sec = $v.video.duration;
    }
    $v.video.currentTime = sec;
};


$v.video.setVolume = function(volume){
    volume = volume.toFixed(1);
    if(volume >= 1){
        volume = 1;
    }
    if(volume <= 0){
        volume = 0;
    }
    $v.video.volume = volume;
    $v.video.muted  = false;
};


$v.video.setSpeed = function(speed){
    if(!$v.video.duration){
        return;
    }
    speed = speed.toFixed(1);
    if(speed >= 3){
        speed = 3;
    }
    if(speed <= 0.5){
        speed = 0.5;
    }
    $v.video.playbackRate = speed;
};


$v.video.isSeekable = function(sec){
    for(var i = 0; i < $v.video.seekable.length; i++){
        if(sec >= $v.video.seekable.start(i) && sec <= $v.video.seekable.end(i)){
            return true;
        }
    }
    return false;
};


$v.video.addEventListener('loadedmetadata', function(){
    $v.comment.get();

    $v.controller.setBuffer();
    $v.controller.setTime($v.video.duration, $v.controller.totalTime);
    $v.form.input.disabled  = false;
    $v.form.button.disabled = false;

    $v.video.volume = $v.user.volume;
    $v.video.fit();

    $v.thumbnail.create();
});


$v.video.addEventListener('canplaythrough', function(){
    $v.video.play();
});


$v.video.addEventListener('timeupdate', function(){
    var sec = Math.floor($v.video.currentTime);
    if(sec === $v.video.prevSec){
        return;
    }
    $v.video.prevSec = sec;

    if(!$v.controller.timeSeekPointer.isDragging){
        $v.controller.timeSeekPointer.setPosition($v.video.currentTime/$v.video.duration);
        $v.controller.setTime(sec, $v.controller.currentTime);
    }
    if(sec in $v.comment.list && $v.video.paused === false && $v.comment.on !== false){
        $v.comment.release($v.comment.list[sec], $v.comment.laneCheck());
    }
});


$v.video.addEventListener('play', function(){
    $v.comment.run();
    $v.controller.playButton.setAttribute("src", $v.controller.parts.pause);
});


$v.video.addEventListener('pause', function(){
    $v.comment.pause();
    $v.controller.playButton.setAttribute("src", $v.controller.parts.play);
});


$v.video.addEventListener('progress', function(){
    $v.controller.setBuffer();
});


$v.video.addEventListener('seeking', function(){
    $v.comment.clear();
});


$v.video.addEventListener('ended', function(){
    $v.comment.clear();
});


$v.video.addEventListener('volumechange', function(){
    if(!$v.video.volume || $v.video.muted){
        $v.controller.volumeButton.setAttribute("src", $v.controller.parts.mute);
        $v.controller.volumeSeekPointer.setPosition(0);
    }
    else{
        $v.controller.volumeButton.setAttribute("src", $v.controller.parts.volume);
        $v.controller.volumeSeekPointer.setPosition($v.video.volume);
        $v.user.volume = $v.video.volume;
    }
});


$v.video.addEventListener('ratechange', function(){
    $v.screen.showOSD("x" + $v.video.playbackRate.toFixed(1));
});


$v.video.addEventListener('click', function(event){
    if(!$v.video.currentTime){
        $v.video.play();
    }
    event.preventDefault();
});


$v.video.addEventListener('dblclick', function(event){
    event.preventDefault();
});


$v.video.addEventListener('error', function(event){
    var error = event.target.error;

    switch(error.code){ // http://www.html5.jp/tag/elements/video.html
        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
            $v.screen.showOSD("動画ファイルが存在しません");
            break;
        case error.MEDIA_ERR_DECODE:
            $v.screen.showOSD("動画ファイルが未対応の形式です");
            break;
        case error.MEDIA_ERR_NETWORK:
            $v.screen.showOSD("動画ファイルのダウンロードが失敗しました");
            break;
        case error.MEDIA_ERR_ABORTED:
            $v.screen.showOSD("動画の再生が中止されました");
            break;
        default:
            $v.screen.showOSD("未知のエラーが発生しました");
            break;
    }
});


//■ thumbnail
$v.thumbnail = {};


$v.thumbnail.mouseenter = false;


$v.thumbnail.create = function(){
    if('ontouchstart' in document){
        return;
    }

    $v.thumbnail.video = $v.video.cloneNode(true);
    $v.thumbnail.video.pause();
    $v.thumbnail.video.muted  = true;
    $v.thumbnail.video.className = 'jsplayer-thumbnail';
    $v.thumbnail.video.style.width  = 192 + 'px';
    $v.thumbnail.video.style.height = 192 * $v.video.videoHeight / $v.video.videoWidth + 'px';

    $v.controller.timeSeek.addEventListener('mousemove', $v.fn.throttle(300, false, $v.thumbnail.show, false));
    $v.controller.timeSeek.addEventListener('mouseenter', function (){
        $v.thumbnail.mouseenter = true;
    });
    $v.controller.timeSeek.addEventListener('mouseleave', function (){
        $v.thumbnail.hide();
        $v.thumbnail.mouseenter = false;
    });

    $v.screen.appendChild($v.thumbnail.video); //挿入場所は変更する必要がある
};


$v.thumbnail.show = function(event){
    if(!$v.thumbnail.video){
        return;
    }
    if(!$v.thumbnail.mouseenter){
        $v.thumbnail.video.style.display = 'none';
        return;
    }

    var width = $v.controller.timeSeekBar.pos.width - $v.controller.timeSeekPointer.Width;
    var pos   = event.clientX - $v.controller.timeSeekBar.pos.left;
    var time  = pos / width * $v.video.duration;
    $v.thumbnail.video.addEventListener('seeked', function handler(){
        $v.thumbnail.video.style.left    = event.clientX - 96 + 'px';
        $v.thumbnail.video.style.top     = $v.controller.timeSeekBar.pos.top - 130 + 'px'; //フルスクリーン時と通常時で変化させる必要がある(またはサムネタグの位置を変える必要がある)
        $v.thumbnail.video.style.display = 'block';
        $v.thumbnail.video.removeEventListener('seeked', handler);
    });
    
    if($v.thumbnail.video.fastSeek){
        $v.thumbnail.video.fastSeek(time);
    }
    else{
        $v.thumbnail.video.currentTime = time;
    }
};


$v.thumbnail.hide = function(){
    if(!$v.thumbnail.video){
        return;
    }
    $v.thumbnail.video.style.display = 'none';
};




//■ comment
$v.comment = {};


$v.comment.release = function(comments, lane){
    var frag  = document.createDocumentFragment();
    var index = 0;
    for(var i = 0; i < lane.length; i++){
        if(!(index in comments)){
            break;
        }
        if(lane[i] === false){
            continue;
        }
        frag.appendChild($v.comment.create(comments[index], i));
        index++;
    }
    if(index){
        $v.screen.insertBefore(frag, $v.screen.firstChild);
    }
};


$v.comment.create = function(data, laneNumber){
    var comment = document.createElement("span");
    comment.textContent = data[0];
    comment.className   = "jsplayer-comment";
    comment.laneNumber  = laneNumber;

    comment.style.top = laneNumber * $v.comment.laneHeight + $v.comment.marginTop + "px";
    comment.style.fontSize = $v.comment.fontSize + "px";
    comment.style.animationName = $v.screen.isFullscreen() ? $v.appName+"fulllane" : $v.appName+"normallane";

    var delay = data[1] - $v.video.currentTime;
    delay = (delay <= 0) ? 0 : delay.toFixed(3)*1000;
    comment.style.animationDelay = delay + "ms";

    return comment;
};


$v.comment.keyframe = function(width){
    var css = "";
    css += "@keyframes " + $v.appName + "normallane{";
    css += "from{transform:translateX(0);}";
    css += "to{transform:translateX(-" + width*5 + "px);}}";
    css += "@keyframes " + $v.appName + "fulllane{";
    css += "from{transform:translateX(0);}";
    css += "to{transform:translateX(-" + screen.width*5 + "px);}}";

    var style = document.createElement('style');
    style.innerHTML = css;
    document.head.appendChild(style);
};


$v.comment.setting = function(height){
    if(height >= 360){
        $v.comment.laneCount  = Math.floor((height-360)/180) + 10;
        $v.comment.laneHeight = height / $v.comment.laneCount * 0.8;
        $v.comment.fontSize   = $v.comment.laneHeight / 6 * 5; //22.5px以上必要
        $v.comment.marginTop  = $v.comment.laneHeight / 6;
    }
    else{
        $v.comment.laneCount  = Math.floor(height*0.8/30);
        $v.comment.laneHeight = 30;
        $v.comment.fontSize   = 25;
        $v.comment.marginTop  = 5;
    }
};


$v.comment.laneCheck = function(){
    var lane = Array($v.comment.laneCount);
    for(var i = 0; i < lane.length; i++){
        lane[i] = true;
    }
 
    var comments = $v.screen.querySelectorAll(".jsplayer-comment");
    for(var i = comments.length-1; i >= 0; i--){
        comments[i].pos = comments[i].getBoundingClientRect();
        if(comments[i].pos.right > $v.screen.pos.right-30){
            lane[comments[i].laneNumber] = false;
        }
        if(comments[i].pos.right < $v.screen.pos.left){
            $v.screen.removeChild(comments[i]);
        }
    }
    return lane;
};


$v.comment.clear = function(){
    var comments = $v.screen.querySelectorAll(".jsplayer-comment");
    for(var i = comments.length-1; i >= 0; i--){
        $v.screen.removeChild(comments[i]);
    }
};


$v.comment.pause = function(){
    var comments = $v.screen.querySelectorAll(".jsplayer-comment");
    for(var i = 0; i < comments.length; i++){
        comments[i].style.animationPlayState = "paused";
    }
};


$v.comment.run = function(){
    var comments = $v.screen.querySelectorAll(".jsplayer-comment");
    for(var i = 0; i < comments.length; i++){
        comments[i].style.animationPlayState = "running";
    }
};


$v.comment.get = function(){
    var sec  = Math.floor($v.video.duration);

    $v.comment.list = Array(sec+1); //動画時間+1の箱を作る [[],[],[],[]...]
    for(var i = 0; i < $v.comment.list.length; i++){
        $v.comment.list[i] = [];
    }

    var url = "?" + $v.fn.param({
        "action"   : "commentget",
        "id"       : $v.form.vid.value,
        "登録時間" : $v.form.time.value,
        "件数"     : sec * 4,
        "nocache"  : Date.now()
    });

    $v.fn.get(url, function(xhr){
        try{
            var comments = JSON.parse(xhr.responseText);
        }
        catch(e){
            return;
        }

        for(var i = 0; i < comments.length; i++){
            if(comments[i].本文 == null){
                continue;
            }
            var index = Math.floor(comments[i].位置/100);
            if(index in $v.comment.list){
                $v.comment.list[index].push([comments[i].本文.substring(0,64), comments[i].位置/100]);
            }
        }
    });
};


$v.comment.post = function(){
    var sec  = $v.video.currentTime;
    var text = $v.form.input.value.trim();

    if(text == "" || text.length > 64){
        return;
    }

    $v.comment.list[Math.floor(sec+1)].unshift([text, sec+1, Math.floor(Date.now()/1000)]);
    $v.form.input.value = "";

    var formdata = new FormData($v.form);
    formdata.append("本文", text);
    formdata.append("位置", sec.toFixed(2)*100);
    $v.fn.post('?action=commentpost', formdata);
};



//■ controller
$v.controller                   = $v.querySelector(".jsplayer-controller");
$v.controller.timeSeek          = $v.querySelector(".jsplayer-controller-timeSeek");
$v.controller.timeSeekBar       = $v.querySelector(".jsplayer-controller-timeSeekBar");
$v.controller.timeSeekPointer   = $v.querySelector(".jsplayer-controller-timeSeekPointer")
$v.controller.volumeSeek        = $v.querySelector(".jsplayer-controller-volumeSeek")
$v.controller.volumeSeekBar     = $v.querySelector(".jsplayer-controller-volumeSeekBar");
$v.controller.volumeSeekPointer = $v.querySelector(".jsplayer-controller-volumeSeekPointer");
$v.controller.currentTime       = $v.querySelector(".jsplayer-controller-currentTime");
$v.controller.totalTime         = $v.querySelector(".jsplayer-controller-totalTime");
$v.controller.playButton        = $v.querySelector(".jsplayer-controller-playButton");
$v.controller.volumeButton      = $v.querySelector(".jsplayer-controller-volumeButton");
$v.controller.commentButton     = $v.querySelector(".jsplayer-controller-commentButton");
$v.controller.fullscreenButton  = $v.querySelector(".jsplayer-controller-fullscreenButton");

$v.controller.parts = {
    play:       "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNTc2IDkyN2wtMTMyOCA3MzhxLTIzIDEzLTM5LjUgM3QtMTYuNS0zNnYtMTQ3MnEwLTI2IDE2LjUtMzZ0MzkuNSAzbDEzMjggNzM4cTIzIDEzIDIzIDMxdC0yMyAzMXoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=",
    pause:      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNjY0IDE5MnYxNDA4cTAgMjYtMTkgNDV0LTQ1IDE5aC01MTJxLTI2IDAtNDUtMTl0LTE5LTQ1di0xNDA4cTAtMjYgMTktNDV0NDUtMTloNTEycTI2IDAgNDUgMTl0MTkgNDV6bS04OTYgMHYxNDA4cTAgMjYtMTkgNDV0LTQ1IDE5aC01MTJxLTI2IDAtNDUtMTl0LTE5LTQ1di0xNDA4cTAtMjYgMTktNDV0NDUtMTloNTEycTI2IDAgNDUgMTl0MTkgNDV6IiBmaWxsPSIjZmZmIi8+PC9zdmc+",
    volume:     "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik04MzIgMzUydjEwODhxMCAyNi0xOSA0NXQtNDUgMTktNDUtMTlsLTMzMy0zMzNoLTI2MnEtMjYgMC00NS0xOXQtMTktNDV2LTM4NHEwLTI2IDE5LTQ1dDQ1LTE5aDI2MmwzMzMtMzMzcTE5LTE5IDQ1LTE5dDQ1IDE5IDE5IDQ1em0zODQgNTQ0cTAgNzYtNDIuNSAxNDEuNXQtMTEyLjUgOTMuNXEtMTAgNS0yNSA1LTI2IDAtNDUtMTguNXQtMTktNDUuNXEwLTIxIDEyLTM1LjV0MjktMjUgMzQtMjMgMjktMzUuNSAxMi01Ny0xMi01Ny0yOS0zNS41LTM0LTIzLTI5LTI1LTEyLTM1LjVxMC0yNyAxOS00NS41dDQ1LTE4LjVxMTUgMCAyNSA1IDcwIDI3IDExMi41IDkzdDQyLjUgMTQyem0yNTYgMHEwIDE1My04NSAyODIuNXQtMjI1IDE4OC41cS0xMyA1LTI1IDUtMjcgMC00Ni0xOXQtMTktNDVxMC0zOSAzOS01OSA1Ni0yOSA3Ni00NCA3NC01NCAxMTUuNS0xMzUuNXQ0MS41LTE3My41LTQxLjUtMTczLjUtMTE1LjUtMTM1LjVxLTIwLTE1LTc2LTQ0LTM5LTIwLTM5LTU5IDAtMjYgMTktNDV0NDUtMTlxMTMgMCAyNiA1IDE0MCA1OSAyMjUgMTg4LjV0ODUgMjgyLjV6bTI1NiAwcTAgMjMwLTEyNyA0MjIuNXQtMzM4IDI4My41cS0xMyA1LTI2IDUtMjYgMC00NS0xOXQtMTktNDVxMC0zNiAzOS01OSA3LTQgMjIuNS0xMC41dDIyLjUtMTAuNXE0Ni0yNSA4Mi01MSAxMjMtOTEgMTkyLTIyN3Q2OS0yODktNjktMjg5LTE5Mi0yMjdxLTM2LTI2LTgyLTUxLTctNC0yMi41LTEwLjV0LTIyLjUtMTAuNXEtMzktMjMtMzktNTkgMC0yNiAxOS00NXQ0NS0xOXExMyAwIDI2IDUgMjExIDkxIDMzOCAyODMuNXQxMjcgNDIyLjV6IiBmaWxsPSIjZmZmIi8+PC9zdmc+",
    mute:       "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im04MzIsMzQ4bDAsMTA4OHEwLDI2IC0xOSw0NXQtNDUsMTl0LTQ1LC0xOWwtMzMzLC0zMzNsLTI2MiwwcS0yNiwwIC00NSwtMTl0LTE5LC00NWwwLC0zODRxMCwtMjYgMTksLTQ1dDQ1LC0xOWwyNjIsMGwzMzMsLTMzM3ExOSwtMTkgNDUsLTE5dDQ1LDE5dDE5LDQ1eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",
    commenton:  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im02NDAsNzkycTAsLTUzIC0zNy41LC05MC41dC05MC41LC0zNy41dC05MC41LDM3LjV0LTM3LjUsOTAuNXQzNy41LDkwLjV0OTAuNSwzNy41dDkwLjUsLTM3LjV0MzcuNSwtOTAuNXptMzg0LDBxMCwtNTMgLTM3LjUsLTkwLjV0LTkwLjUsLTM3LjV0LTkwLjUsMzcuNXQtMzcuNSw5MC41dDM3LjUsOTAuNXQ5MC41LDM3LjV0OTAuNSwtMzcuNXQzNy41LC05MC41em0zODQsMHEwLC01MyAtMzcuNSwtOTAuNXQtOTAuNSwtMzcuNXQtOTAuNSwzNy41dC0zNy41LDkwLjV0MzcuNSw5MC41dDkwLjUsMzcuNXQ5MC41LC0zNy41dDM3LjUsLTkwLjV6bTM4NCwwcTAsMTc0IC0xMjAsMzIxLjV0LTMyNiwyMzN0LTQ1MCw4NS41cS0xMTAsMCAtMjExLC0xOHEtMTczLDE3MyAtNDM1LDIyOXEtNTIsMTAgLTg2LDEzcS0xMiwxIC0yMiwtNnQtMTMsLTE4cS00LC0xNSAyMCwtMzdxNSwtNSAyMy41LC0yMS41dDI1LjUsLTIzLjV0MjMuNSwtMjUuNXQyNCwtMzEuNXQyMC41LC0zN3QyMCwtNDh0MTQuNSwtNTcuNXQxMi41LC03Mi41cS0xNDYsLTkwIC0yMjkuNSwtMjE2LjV0LTgzLjUsLTI2OS41cTAsLTE3NCAxMjAsLTMyMS41dDMyNiwtMjMzLjAwMDA3NnQ0NTAsLTg1LjUwMDMydDQ1MCw4NS41MDAzMnQzMjYsMjMzLjAwMDA3NnQxMjAsMzIxLjV6IiBmaWxsPSIjZmZmIi8+PC9zdmc+",
    commentoff: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im0xNzkyLDc5MnEwLDE3NCAtMTIwLDMyMS41dC0zMjYsMjMzdC00NTAsODUuNXEtNzAsMCAtMTQ1LC04cS0xOTgsMTc1IC00NjAsMjQycS00OSwxNCAtMTE0LDIycS0xNywyIC0zMC41LC05dC0xNy41LC0yOWwwLC0xcS0zLC00IC0wLjUsLTEydDIsLTEwdDQuNSwtOS41bDYsLTlsNywtOC41bDgsLTlxNywtOCAzMSwtMzQuNXQzNC41LC0zOHQzMSwtMzkuNXQzMi41LC01MXQyNywtNTl0MjYsLTc2cS0xNTcsLTg5IC0yNDcuNSwtMjIwdC05MC41LC0yODFxMCwtMTMwIDcxLC0yNDguNXQxOTEsLTIwNC41MDA3OTN0Mjg2LC0xMzYuNDk5Nzg2dDM0OCwtNTAuNDk5ODE3cTI0NCwwIDQ1MCw4NS40OTk2OHQzMjYsMjMzLjAwMDM4MXQxMjAsMzIxLjUwMDMzNnoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=",
    fullscreen: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik04ODMgMTA1NnEwIDEzLTEwIDIzbC0zMzIgMzMyIDE0NCAxNDRxMTkgMTkgMTkgNDV0LTE5IDQ1LTQ1IDE5aC00NDhxLTI2IDAtNDUtMTl0LTE5LTQ1di00NDhxMC0yNiAxOS00NXQ0NS0xOSA0NSAxOWwxNDQgMTQ0IDMzMi0zMzJxMTAtMTAgMjMtMTB0MjMgMTBsMTE0IDExNHExMCAxMCAxMCAyM3ptNzgxLTg2NHY0NDhxMCAyNi0xOSA0NXQtNDUgMTktNDUtMTlsLTE0NC0xNDQtMzMyIDMzMnEtMTAgMTAtMjMgMTB0LTIzLTEwbC0xMTQtMTE0cS0xMC0xMC0xMC0yM3QxMC0yM2wzMzItMzMyLTE0NC0xNDRxLTE5LTE5LTE5LTQ1dDE5LTQ1IDQ1LTE5aDQ0OHEyNiAwIDQ1IDE5dDE5IDQ1eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",
    setting:    "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc5MiIgaGVpZ2h0PSIxNzkyIiB2aWV3Qm94PSIwIDAgMTc5MiAxNzkyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMTUyIDg5NnEwLTEwNi03NS0xODF0LTE4MS03NS0xODEgNzUtNzUgMTgxIDc1IDE4MSAxODEgNzUgMTgxLTc1IDc1LTE4MXptNTEyLTEwOXYyMjJxMCAxMi04IDIzdC0yMCAxM2wtMTg1IDI4cS0xOSA1NC0zOSA5MSAzNSA1MCAxMDcgMTM4IDEwIDEyIDEwIDI1dC05IDIzcS0yNyAzNy05OSAxMDh0LTk0IDcxcS0xMiAwLTI2LTlsLTEzOC0xMDhxLTQ0IDIzLTkxIDM4LTE2IDEzNi0yOSAxODYtNyAyOC0zNiAyOGgtMjIycS0xNCAwLTI0LjUtOC41dC0xMS41LTIxLjVsLTI4LTE4NHEtNDktMTYtOTAtMzdsLTE0MSAxMDdxLTEwIDktMjUgOS0xNCAwLTI1LTExLTEyNi0xMTQtMTY1LTE2OC03LTEwLTctMjMgMC0xMiA4LTIzIDE1LTIxIDUxLTY2LjV0NTQtNzAuNXEtMjctNTAtNDEtOTlsLTE4My0yN3EtMTMtMi0yMS0xMi41dC04LTIzLjV2LTIyMnEwLTEyIDgtMjN0MTktMTNsMTg2LTI4cTE0LTQ2IDM5LTkyLTQwLTU3LTEwNy0xMzgtMTAtMTItMTAtMjQgMC0xMCA5LTIzIDI2LTM2IDk4LjUtMTA3LjV0OTQuNS03MS41cTEzIDAgMjYgMTBsMTM4IDEwN3E0NC0yMyA5MS0zOCAxNi0xMzYgMjktMTg2IDctMjggMzYtMjhoMjIycTE0IDAgMjQuNSA4LjV0MTEuNSAyMS41bDI4IDE4NHE0OSAxNiA5MCAzN2wxNDItMTA3cTktOSAyNC05IDEzIDAgMjUgMTAgMTI5IDExOSAxNjUgMTcwIDcgOCA3IDIyIDAgMTItOCAyMy0xNSAyMS01MSA2Ni41dC01NCA3MC41cTI2IDUwIDQxIDk4bDE4MyAyOHExMyAyIDIxIDEyLjV0OCAyMy41eiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=="
};


$v.controller.setBuffer = function(){
    var seekbarWidth = $v.controller.timeSeekBar.pos.width;
    var buffer = $v.video.buffered;

    if(buffer.length){
        $v.controller.timeSeekBar.style.backgroundPosition = buffer.start(0) / $v.video.duration * seekbarWidth + "px";
        $v.controller.timeSeekBar.style.backgroundSize     = buffer.end(buffer.length-1) / $v.video.duration * seekbarWidth + "px";
    }
};


$v.controller.setTime = function(time, where){
    var min = Math.floor(time / 60);
    var sec = Math.floor(time - min * 60);

    if(min < 10){
        min = '0' + min;
    }
    if(sec < 10){
        sec = '0' + sec;
    }

    where.textContent = min + ":" + sec;
};


$v.controller.toggle = function(event){
    if($v.controller.timeSeekPointer.isDragging){
        return;
    }

    if($v.controller.style.visibility == "hidden"){
        event.preventDefault();
        $v.controller.style.visibility = "visible";
    }
    else{
        var controller = $v.controller.getBoundingClientRect();
        if(controller.left <= event.clientX && controller.right >= event.clientX){
            if(controller.top <= event.clientY && controller.bottom >= event.clientY){
                return;
            }
        }
        $v.controller.style.visibility = "hidden";
    }
};


$v.controller.intoScreen = function(){
    $v.screen.appendChild($v.controller);
    var controller = $v.controller.getBoundingClientRect();
    $v.controller.style.top  = screen.height - controller.height + "px";
    $v.controller.style.left = (screen.width/2) - (controller.width/2) + "px";
    $v.controller.style.visibility = "hidden";
};


$v.controller.outofScreen = function(){
    $v.appendChild($v.controller);
    $v.controller.style.top  = 0;
    $v.controller.style.left = 0;
    $v.controller.style.visibility = "visible";
};


$v.controller.timeSeekPointer.setPosition = function(time){
    var width = $v.controller.timeSeekBar.pos.width - $v.controller.timeSeekPointer.Width;
    var pos   = (time <= 1)  ?  width * time  :  time - $v.controller.timeSeekBar.pos.left; //timeは「割合の時(0-1)」or「クリックされた位置の時」の2パターンある

    if(pos < 0){
        pos = 0;
    }
    if(pos > width){
        pos = width;
    }

    $v.controller.timeSeekPointer.style.left = pos + "px";
    return pos / width;
};


$v.controller.volumeSeekPointer.setPosition = function(vol){
    var width = $v.controller.volumeSeekBar.pos.width - $v.controller.volumeSeekPointer.Width;
    var pos   = (vol <= 1)  ?  width * vol  :  vol - $v.controller.volumeSeekBar.pos.left; //volは「割合の時(0-1)」or「クリックされた位置の時」の2パターンある

    if(pos < 0){
        pos = 0;
    }
    if(pos > width){
        pos = width;
    }

    $v.controller.volumeSeekPointer.style.left = pos + "px";
    return pos / width;
};


$v.controller.timeSeekPointer.mousemoveEvent = function(event, seekend){
    var percent = $v.controller.timeSeekPointer.setPosition(event.clientX);
    $v.controller.setTime($v.video.duration*percent, $v.controller.currentTime);
    if(seekend){
        $v.video.currentTime = $v.video.duration * percent;
    }
};


$v.controller.volumeSeekPointer.mousemoveEvent = function(event){
    $v.video.volume = $v.controller.volumeSeekPointer.setPosition(event.clientX);
};


$v.controller.playButton.addEventListener('click', function(){
    $v.video.paused ? $v.video.play() : $v.video.pause();
});


$v.controller.timeSeek.addEventListener('click', function(event){
    if(!$v.video.duration){
        return;
    }
    var percent = $v.controller.timeSeekPointer.setPosition(event.clientX);
    $v.video.currentTime = $v.video.duration * percent;

});


$v.controller.timeSeek.addEventListener('wheel', function(event){
    if(!$v.video.duration){
        return;
    }
    (event.deltaY > 0) ? $v.video.setTime($v.video.currentTime+15) : $v.video.setTime($v.video.currentTime-15);
});


$v.controller.timeSeekPointer.addEventListener('mousedown', function(event){
    if(!$v.video.duration){
        return;
    }
    $v.controller.timeSeekPointer.isDragging = true;
    document.addEventListener('mousemove', $v.controller.timeSeekPointer.mousemoveEvent);
    document.addEventListener('mouseup', function mouseupEvent(event){
        $v.controller.timeSeekPointer.mousemoveEvent(event, true);
        document.removeEventListener('mousemove', $v.controller.timeSeekPointer.mousemoveEvent);
        document.removeEventListener('mouseup',  mouseupEvent);
        $v.controller.timeSeekPointer.isDragging = false;
    });
});


$v.controller.volumeSeek.addEventListener('click', function(event){
    $v.video.muted = false;
    $v.video.volume = $v.controller.volumeSeekPointer.setPosition(event.clientX);
});


$v.controller.volumeSeek.addEventListener('wheel', function(event){
    (event.deltaY < 0) ? $v.video.setVolume($v.video.volume+0.1) : $v.video.setVolume($v.video.volume-0.1);
});


$v.controller.volumeSeekPointer.addEventListener('mousedown', function(event){
    document.addEventListener('mousemove', $v.controller.volumeSeekPointer.mousemoveEvent);
    document.addEventListener('mouseup', function mouseupEvent(event){
        document.removeEventListener('mousemove', $v.controller.volumeSeekPointer.mousemoveEvent);
        document.removeEventListener('mouseup', mouseupEvent);
    });
});


$v.controller.volumeButton.addEventListener('click', function(){
    if($v.video.muted){
        $v.video.muted = false;
        $v.video.volume = 0.5;
    }
    else{
        $v.video.volume = $v.video.volume ? 0 : 0.5;
    }
});


$v.controller.commentButton.addEventListener('click', function(){
    if($v.comment.on){
        $v.comment.on = false;
        $v.comment.clear();
        $v.controller.commentButton.setAttribute("src", $v.controller.parts.commentoff);
    }
    else{
        $v.comment.on = true;
        $v.controller.commentButton.setAttribute("src", $v.controller.parts.commenton);
    }
});


$v.controller.fullscreenButton.addEventListener('click', function(){
    $v.screen.toggleFullscreen();
});



//■ form
$v.form        = $v.querySelector(".jsplayer-form");
$v.form.input  = $v.querySelector(".jsplayer-form-input");
$v.form.button = $v.querySelector(".jsplayer-form-button");
$v.form.vid    = $v.querySelector(".jsplayer-form-vid");
$v.form.time   = $v.querySelector(".jsplayer-form-time");


$v.form.addEventListener('submit', function(event){
    event.preventDefault();
    $v.comment.post();
    $v.video.play();
    $v.screen.focus();
});


$v.form.input.addEventListener('focus', function(event){
    $v.video.pause();
});




//■ function
$v.fn = {};


$v.fn.get = function(url, success){
    $v.fn.ajax(url, {method:"GET", success:success});
};


$v.fn.post = function(url, data, success){
    $v.fn.ajax(url, {method:"POST", data:data, success:success});
};


$v.fn.ajax = function(url, option){ //method, data, timeout, credential, header, success, error, complete
    option = option || {};
    option.method  = option.method  || "GET";
    option.timeout = option.timeout || 60;

    var body = "";
    var xhr  = new XMLHttpRequest();
    xhr.open(option.method, url);

    if(option.timeout >= 0){
        xhr.timeout = option.timeout * 1000;
    }
    if(option.credential){
        xhr.withCredentials = true;
    }
    if(option.method.match(/^POST$/i)){
        if(option.data instanceof FormData){
            body = option.data;
        }
        else{
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            for(var key in option.data){
                body += encodeURIComponent(key) + "=" + encodeURIComponent(option.data[key]) + "&";
            }
        }
    }
    if(option.header){
        for(var key in option.header){
            xhr.setRequestHeader(key, option.header[key]);
        }
    }
    xhr.addEventListener('loadend', function(){
        if(xhr.status >= 200 && xhr.status < 300 || xhr.status == 304){
            if(typeof option.success === "function"){
                option.success(xhr);
            }
        }
        else{
            if(typeof option.error === "function"){
                option.error(xhr);
            }
        }
        if(typeof option.complete === "function"){
            option.complete(xhr);
        }
    });

    xhr.send(body);
};


$v.fn.param = function(param){
    var str = "";
    for(var key in param){
        if(!param.hasOwnProperty(key)){
            continue;
        }
        str += encodeURIComponent(key) + "=" + encodeURIComponent(param[key]) + "&";
    }
    return str;
};


$v.fn.deparam = function(str){
    if(str == null){ return {}; }
    str = String(str);
    str = str.replace(/^\?/, "");
    str = str.replace(/#.*/, "");
    var result = {};
    var namevalue = str.split('&');
    for(var i = 0; i < namevalue.length; i++){
        var name  = namevalue[i].split('=')[0] || "";
        var value = namevalue[i].split('=')[1] || "";
        if(name == ""){
            continue;
        }
        result[decodeURIComponent(name)] = decodeURIComponent(value);
    }
    return result;
};


$v.fn.saveLocalStorage = function(name, value){
    try{
        window.localStorage.setItem(name, JSON.stringify(value));
    }
    catch(e){
    }
};


$v.fn.loadLocalStorage = function(name){
    try{
        return JSON.parse(window.localStorage.getItem(name));
    }
    catch(e){
    }
};


$v.fn.contentFit = function(screenW, screenH, objectW, objectH){
    var scale = (objectW/objectH > screenW/screenH) ? screenW/objectW : screenH/objectH;
    return {
        w: Math.floor(objectW * scale),
        h: Math.floor(objectH * scale),
        x: Math.floor((screenW / 2) - (objectW * scale / 2)),
        y: Math.floor((screenH / 2) - (objectH * scale / 2)),
    };
};


$v.fn.throttle = function(delay, noTrailing, callback, debounceMode){
    // https://github.com/niksy/throttle-debounce
    //delay: 間引く間隔(ms)
    //noTrailing: false(初期値)なら連続処理の終了時に関数を実行する。trueなら実行しない
    //callback: 関数
    //debounceMode: true:連続処理の開始時に1度だけ実行、false:連続処理の終了時に1度だけ実行

	var timeoutID;
	var lastExec = 0;

	if (typeof noTrailing !== 'boolean'){
		debounceMode = callback;
		callback = noTrailing;
		noTrailing = undefined;
	}

	function wrapper(){
		var self = this;
		var elapsed = Number(new Date()) - lastExec;
		var args = arguments;

		function exec(){
			lastExec = Number(new Date());
			callback.apply(self, args);
		}

		function clear(){
			timeoutID = undefined;
		}

		if(debounceMode && !timeoutID){
			exec();
        }

		if(timeoutID){
			clearTimeout(timeoutID);
		}

		if(debounceMode === undefined && elapsed > delay){
			exec();
		}
        else if(noTrailing !== true){
			timeoutID = setTimeout(debounceMode ? clear : exec, debounceMode === undefined ? delay - elapsed : delay);
		}
	}
	return wrapper;
};


$v.fn.type = function(target){
    return Object.prototype.toString.call(target).replace(/^\[object (.+)\]$/, '$1').toLowerCase();
};




//■ jsplayer.html特有のコード
$v.comment.get = function(){
    var sec  = Math.floor($v.video.duration);

    $v.comment.list = Array(sec+1); //動画時間+1の箱を作る [[],[],[],[]...]
    for(var i = 0; i < $v.comment.list.length; i++){
        $v.comment.list[i] = [];
    }

    if(!$v.query.himado){
        return;
    }

    var api1 = "https://query.yahooapis.com/v1/public/yql?" + $v.fn.param({
        "format"   : "json",
        "q"        : "SELECT * FROM html WHERE url = 'http://himado.in/" + $v.query.himado + "' and xpath='//input[@type=\"hidden\"]'"
    });

    $v.fn.ajax(api1, {success:function(xhr){
        try{
            var input = JSON.parse(xhr.responseText).query.results.input;
        }
        catch(e){
            input = [];
        }

        for(var i = 0; i < input.length; i++){
            if(input[i].name == "group_id"){
                var group_id = input[i].value;
            }
            if(input[i].name == "key"){
                var key = input[i].value;
            }
        }

        var url = "http://himado.in/?" + $v.fn.param({
            "mode"     : "comment",
            "format"   : "nico",
            "limit"    : 10000,
            "id"       : $v.query.himado,
            "group_id" : $v.query.group_id || group_id || "",
            "key"      : $v.query.key || key || "",
            "nocache"  : Date.now()
        });

        var api2 = "https://query.yahooapis.com/v1/public/yql?" + $v.fn.param({
            "format"   : "json",
            "q"        : "SELECT * FROM xml WHERE url = '" + url + "'"
        });

        $v.fn.ajax(api2, {success:function(xhr){
            try{
                var comments = JSON.parse(xhr.responseText).query.results.packet.chat;
                console.log(comments.length + "件のコメント取得");
            }
            catch(e){
                console.log("API2においてコメントが取得できません");
                return;
            }
            for(var i = comments.length-1; i >= 0; i--){
                if(comments[i].content == null){
                    continue;
                }
                var index = Math.floor(comments[i].vpos/100);
                if(index in $v.comment.list){
                    $v.comment.list[index].push([comments[i].content.substring(0,64), comments[i].vpos/100]);
                }
            }
        }, error: function(){ console.log("API2に接続失敗"); }});
    }, error: function(){ console.log("API1に接続失敗"); }});
};


$v.comment.post = function(){
    var sec  = $v.video.currentTime;
    var text = $v.form.input.value.trim();

    if(text == "" || text.length > 64){
        return;
    }

    $v.comment.list[Math.floor(sec+1)].unshift([text, sec+1, Math.floor(Date.now()/1000)]);
    $v.form.input.value = "";

    if(!$v.query.himado){
        return;
    }

    var postdata = $v.fn.param({
        "mode"    : "comment",
        "id"      : $v.query.himado,
        "vpos"    : sec.toFixed(2)*100,
        "comment" : text,
        "adddate" : Math.floor(Date.now()/1000)
    });

    var api = "https://query.yahooapis.com/v1/public/yql?" + $v.fn.param({
        "format"   : "json",
        "env"      : "store://datatables.org/alltableswithkeys",
        "q"        : "SELECT * FROM htmlpost WHERE url = 'http://himado.in/' AND postdata='" + postdata + "' AND xpath='//p'"
    });

    $v.fn.get(api);
};
</script>





<script>
//■ エントリーポイント
$v.query = $v.fn.deparam(location.search);

//$v.query.file     = ""; //動画ファイルのURL (必須)
//$v.query.himado   = ""; //ひま動のID
//$v.query.group_id = ""; //ひま動のgroup_id
//$v.query.key      = ""; //ひま動のkey

$v.entrypoint($v.query.file, 960, 540);
</script>

